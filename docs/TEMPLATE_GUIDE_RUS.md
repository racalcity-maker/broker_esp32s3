# Р СѓРєРѕРІРѕРґСЃС‚РІРѕ РїРѕ С€Р°Р±Р»РѕРЅР°Рј Рё СЃС†РµРЅР°СЂРёСЏРј

Р­С‚РѕС‚ РґРѕРєСѓРјРµРЅС‚ РґР°С‘С‚ РїСЂР°РєС‚РёС‡РµСЃРєРёРµ РїСЂРёРјРµСЂС‹ РґР»СЏ РєР°Р¶РґРѕРіРѕ РІСЃС‚СЂРѕРµРЅРЅРѕРіРѕ С€Р°Р±Р»РѕРЅР°. Р’ РєР°Р¶РґРѕРј СЂР°Р·РґРµР»Рµ РѕРїРёСЃР°РЅРѕ:

- РљР°Рє РЅР°СЃС‚СЂРѕРёС‚СЊ СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РІРѕ РІРєР»Р°РґРєРµ Devices.
- РљР°РєРёРµ СЃС†РµРЅР°СЂРёРё СЃРѕР·РґР°С‘С‚ РёР»Рё РёСЃРїРѕР»СЊР·СѓРµС‚ С€Р°Р±Р»РѕРЅ.
- РљР°Рє СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ Р°РІС‚РѕРјР°С‚РёР·Р°С†РёСЏ СЂР°Р±РѕС‚Р°РµС‚ РєРѕСЂСЂРµРєС‚РЅРѕ.

---

## 1. UID Validator (СЃС‡РёС‚С‹РІР°С‚РµР»Рё РєР°СЂС‚)

**Р¦РµР»СЊ:** РґРІР° СЃС‡РёС‚С‹РІР°С‚РµР»СЏ РґРѕР»Р¶РЅС‹ РїСЂРёРЅСЏС‚СЊ Р·Р°РґР°РЅРЅС‹Рµ UID. РџСЂРё СѓСЃРїРµС…Рµ РёРіСЂР°РµРј `success.mp3` Рё РѕС‚РїСЂР°РІР»СЏРµРј РїРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ РїРѕ MQTT, РїСЂРё РѕС€РёР±РєРµ вЂ” `fail.mp3`.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `pictures_pair`
   - Template: `UID Validator`
2. **РЎР»РѕС‚С‹**
   - РЎР»РѕС‚ 1: `source_id = pictures/uid/scan1`, `values = ABC123, DEF456`
   - РЎР»РѕС‚ 2: `source_id = pictures/uid/scan2`, `values = 112233`
3. **Р”РµР№СЃС‚РІРёСЏ**
   - РЈСЃРїРµС…: `success_topic = pictures/cmd/success`, `success_payload = ok`, `success_audio_track = /sdcard/audio/success.mp3`
   - РћС€РёР±РєР°: `fail_topic = pictures/cmd/fail`, `fail_payload = fail`, `fail_audio_track = /sdcard/audio/fail.mp3`
4. **РЎС†РµРЅР°СЂРёРё** (СЃРѕР·РґР°СЋС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё)
   - `uid_success`: РїСѓР±Р»РёРєР°С†РёСЏ MQTT + Р·Р°РїСѓСЃРє С‚СЂРµРєР° СѓСЃРїРµС…Р°.
   - `uid_fail`: Р°РЅР°Р»РѕРіРёС‡РЅРѕ, РЅРѕ РґР»СЏ РЅРµРІР°Р»РёРґРЅС‹С… РєР°СЂС‚.
5. **РџСЂРѕРІРµСЂРєР°**
   - РћС‚РїСЂР°РІСЊС‚Рµ `ABC123` РІ `pictures/uid/scan1` Рё `112233` РІ `pictures/uid/scan2`. Р’ Р»РѕРіР°С… РїРѕСЏРІРёС‚СЃСЏ `[UID] ... event=success`.
   - Р›СЋР±РѕР№ РґСЂСѓРіРѕР№ UID Р·Р°РїСѓСЃРєР°РµС‚ `uid_fail`.

---

## 2. Signal Hold (Р»Р°Р·РµСЂРЅР°СЏ РіРѕР»РѕРІРѕР»РѕРјРєР°)

**Р¦РµР»СЊ:** РµСЃР»Рё Р»СѓС‡ РґРµСЂР¶РёС‚СЃСЏ 20 СЃРµРєСѓРЅРґ РЅР° С„РѕС‚РѕСЂРµР·РёСЃС‚РѕСЂРµ, РІС‹РєР»СЋС‡РёС‚СЊ СЂРµР»Рµ, РїСЂРѕРёРіСЂР°С‚СЊ `complete.mp3` Рё РѕРїСѓР±Р»РёРєРѕРІР°С‚СЊ `done`. Р•СЃР»Рё Р»СѓС‡ РїСЂРѕРїР°Р» вЂ” РѕСЃС‚Р°РЅРѕРІРёС‚СЊ С†РёРєР»РёС‡РЅС‹Р№ С‚СЂРµРє.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `laser_guard`
   - Template: `Signal Hold`
2. **РџРѕР»СЏ**
   - `signal_topic = laser/relay/cmd`
   - `signal_payload_on = ON`, `signal_payload_off = OFF`
   - `heartbeat_topic = laser/heartbeat`
   - `required_hold_ms = 20000`
   - `heartbeat_timeout_ms = 1500`
   - `hold_track = /sdcard/audio/hold_loop.mp3`, `hold_track_loop = true`
   - `complete_track = /sdcard/audio/complete.mp3`
3. **РЎС†РµРЅР°СЂРёР№** (Р°РІС‚Рѕ)
   - `signal_complete`: РѕС‚РїСЂР°РІРёС‚СЊ ON, РїСЂРѕРёРіСЂР°С‚СЊ С„РёРЅР°Р»СЊРЅС‹Р№ С‚СЂРµРє, Р·Р°РґРµСЂР¶Р°С‚СЊСЃСЏ РЅР° `signal_on_ms` РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё Рё РѕС‚РїСЂР°РІРёС‚СЊ OFF.
4. **Р›РѕРіРёРєР° heartbeats**
   - РљР°Р¶РґРѕРµ СЃРѕРѕР±С‰РµРЅРёРµ РІ `laser/heartbeat` РґРѕР±Р°РІР»СЏРµС‚ РїСЂРѕРіСЂРµСЃСЃ. Р•СЃР»Рё >1.5 СЃРµРє С‚РёС€РёРЅР° вЂ” С‚СЂРµРє СЃС‚Р°РІРёС‚СЃСЏ РЅР° РїР°СѓР·Сѓ Рё РЅР°РєРѕРїР»РµРЅРёРµ РѕР±РЅСѓР»СЏРµС‚СЃСЏ.
5. **РџСЂРѕРІРµСЂРєР°**
   - РџСѓР±Р»РёРєСѓР№С‚Рµ heartbeat СЂР°Р· РІ СЃРµРєСѓРЅРґСѓ 20 СЃРµРєСѓРЅРґ вЂ” СЃС†РµРЅР°СЂРёР№ РІС‹РїРѕР»РЅРёС‚СЃСЏ.
   - РџСЂРѕРїСѓСЃРє >1.5 СЃРµРє вЂ” РїР°СѓР·Р° Рё СЃР±СЂРѕСЃ С‚Р°Р№РјРµСЂР°.

---

## 3. MQTT Event Trigger

**Р¦РµР»СЊ:** РµСЃР»Рё RFID С€Р»С‘С‚ `quest/scanner` СЃ payload `scan`, Р·Р°РїСѓСЃРєР°С‚СЊ Р·Р°РїСЂРѕСЃ РІР°Р»РёРґР°С†РёРё; payload `reset` вЂ” РѕС‡РёС‰Р°С‚СЊ СЃРѕСЃС‚РѕСЏРЅРёРµ.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `scanner_controller`
   - Template: `MQTT Event Trigger`
2. **РџСЂР°РІРёР»Р°**
   - РџСЂР°РІРёР»Рѕ 1: `topic = quest/scanner`, `payload = scan`, `payload_required = true`, `scenario = request_scan`
   - РџСЂР°РІРёР»Рѕ 2: `topic = quest/scanner`, `payload = reset`, `scenario = reset_state`
3. **РЎС†РµРЅР°СЂРёРё**
   - `request_scan`: РЁР°Рі 1 вЂ” MQTT `pictures/cmd/scan1` СЃ `scan`. РЁР°Рі 2 вЂ” `set_flag scan_in_progress=true`.
   - `reset_state`: РЁР°Рі 1 вЂ” РѕСЃС‚Р°РЅРѕРІРёС‚СЊ Р°СѓРґРёРѕ (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ). РЁР°Рі 2 вЂ” `set_flag scan_in_progress=false`.
4. **РџСЂРѕРІРµСЂРєР°**
   - РЎРѕРѕР±С‰РµРЅРёРµ `scan` в†’ Р»РѕРі `[MQTT trigger] ... scenario=request_scan`.
   - Р›СЋР±РѕР№ РґСЂСѓРіРѕР№ payload РёРіРЅРѕСЂРёСЂСѓРµС‚СЃСЏ, РµСЃР»Рё `payload_required=true`.

---

## 4. Flag Trigger

**Р¦РµР»СЊ:** РєРѕРіРґР° С„Р»Р°Рі `beam_ok` РїРµСЂРµС…РѕРґРёС‚ РІ true, РІС‹РїРѕР»РЅРёС‚СЊ `laser_ok`. РљРѕРіРґР° `pictures_ready` = false вЂ” `pictures_abort`.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `flag_router`
   - Template: `Flag Trigger`
2. **РџСЂР°РІРёР»Р°**
   - `flag=beam_ok`, `state=true`, `scenario=laser_ok`
   - `flag=pictures_ready`, `state=false`, `scenario=pictures_abort`
3. **РџСЂРёРјРµСЂС‹ СЃС†РµРЅР°СЂРёРµРІ**
   - `laser_ok`: Р·Р°РїСѓСЃС‚РёС‚СЊ `/sdcard/audio/laser_ok.mp3`, РѕРїСѓР±Р»РёРєРѕРІР°С‚СЊ `pictures/cmd/allow`.
   - `pictures_abort`: РѕСЃС‚Р°РЅРѕРІРёС‚СЊ Р°СѓРґРёРѕ, РѕС‚РїСЂР°РІРёС‚СЊ `pictures/cmd/abort`.
4. **РљР°Рє РјРµРЅСЏС‚СЊ С„Р»Р°РіРё**
   - Р”РѕР±Р°РІСЊС‚Рµ С€Р°РіРё `set_flag` РІ РґСЂСѓРіРёС… СЃС†РµРЅР°СЂРёСЏС…, РєРѕС‚РѕСЂС‹Рµ СѓРїСЂР°РІР»СЏСЋС‚ СЌС‚РёРјРё С„Р»Р°РіР°РјРё.
5. **РџСЂРѕРІРµСЂРєР°**
   - РџСЂРё СѓСЃС‚Р°РЅРѕРІРєРµ `beam_ok` РІ true РїРѕСЏРІРёС‚СЃСЏ `[Flag trigger] ... scenario=laser_ok`.

---

## 5. Conditional Scenario (If Condition)

**Р¦РµР»СЊ:** РµСЃР»Рё `beam_ok` Р `uid_complete` СЂР°РІРЅС‹ true вЂ” РІС‹РїРѕР»РЅРёС‚СЊ `all_clear`, РёРЅР°С‡Рµ `wait_retry`.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `condition_router`
   - Template: `Conditional Scenario`
2. **РџРѕР»СЏ**
   - `Logic mode = All conditions`
   - `Scenario if TRUE = all_clear`
   - `Scenario if FALSE = wait_retry`
   - РЈСЃР»РѕРІРёСЏ:
     - `flag=beam_ok`, `state=true`
     - `flag=uid_complete`, `state=true`
3. **РЎС†РµРЅР°СЂРёРё**
   - `all_clear`: MQTT `quest/door/cmd` СЃ `unlock`.
   - `wait_retry`: РїСЂРѕРёРіСЂР°С‚СЊ `please_wait.mp3`.
4. **РџРѕРІРµРґРµРЅРёРµ**
   - РџСЂРё РёР·РјРµРЅРµРЅРёРё Р»СЋР±РѕРіРѕ С„Р»Р°РіР° РІСЃРµ СѓСЃР»РѕРІРёСЏ РїРµСЂРµСЃС‡РёС‚С‹РІР°СЋС‚СЃСЏ; РїСЂРё СЃРјРµРЅРµ СЂРµР·СѓР»СЊС‚Р°С‚Р° Р·Р°РїСѓСЃРєР°РµС‚СЃСЏ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёР№ СЃС†РµРЅР°СЂРёР№.
5. **РџСЂРѕРІРµСЂРєР°**
   - РћР±Р° С„Р»Р°РіР° true в†’ `all_clear`.
   - Р›СЋР±РѕР№ false в†’ `wait_retry`.

---

## 6. Interval Task

**Р¦РµР»СЊ:** РєР°Р¶РґС‹Рµ 10 СЃРµРєСѓРЅРґ РїРѕСЃС‹Р»Р°С‚СЊ heartbeat Рё, РµСЃР»Рё СЃРёСЃС‚РµРјР° СЃРІРѕР±РѕРґРЅР°, РїСЂРѕРёРіСЂС‹РІР°С‚СЊ РєРѕСЂРѕС‚РєРёР№ Р·РІСѓРє.

1. **РЎРѕР·РґР°РЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°**
   - Device ID: `heartbeat_task`
   - Template: `Interval Task`
2. **РџРѕР»СЏ**
   - `interval_ms = 10000`
   - `scenario = heartbeat_tick`
3. **РЎС†РµРЅР°СЂРёР№ `heartbeat_tick`**
   - РЁР°Рі 1: MQTT `broker/heartbeat` СЃ payload `tick`.
   - РЁР°Рі 2: `wait_flags` (СЂРµР¶РёРј `all`, СѓСЃР»РѕРІРёРµ `system_idle=true`, `timeout=0`) вЂ” РѕРїС†РёРѕРЅРЅРѕ.
   - РЁР°Рі 3: РІРѕСЃРїСЂРѕРёР·РІРµСЃС‚Рё `/sdcard/audio/beep.mp3` (РЅРµР±Р»РѕРєРёСЂСѓСЋС‰РёР№).
4. **РџСЂРѕРІРµСЂРєР°**
   - Р’ Р»РѕРіР°С… РєР°Р¶РґС‹Рµ 10 СЃРµРєСѓРЅРґ: `[Interval] dev=heartbeat_task scenario=heartbeat_tick`.
   - MQTT Р±СЂРѕРєРµСЂ РїРѕР»СѓС‡Р°РµС‚ СЃРѕРѕР±С‰РµРЅРёСЏ `broker/heartbeat`.

---

## 7. Sequence Lock (последовательный MQTT-пазл)

**Цель:** Шесть сенсорных площадок отправляют MQTT-сообщения plate/1 … plate/6. Игроки должны пройти их в правильном порядке; верная последовательность включает зелёный свет и success.mp3, любая ошибка или таймаут сбрасывает прогресс, зажигает красный свет и ail.mp3.

1. **Создание устройства**
   - Device ID: sequence_gate`r
   - Template: Sequence Lock`r
2. **Шаги**
   - Шаг 1: 	opic = plate/1, payload = touch, payload_required = true`r
   - Шаг 2: 	opic = plate/2, payload = touch, payload_required = true`r
   - Продолжайте до шага 6 со своими топиками.
   - При желании добавьте подсказки: hint_topic = hints/led, hint_payload = 1, hint_audio_track = /sdcard/audio/hint1.mp3, чтобы игроки сразу видели правильный ход.
3. **Параметры рантайма**
   - 	imeout_ms = 8000 — если следующий шаг не приходит в течение 8 секунд, прогресс сбрасывается.
   - eset_on_error = true — любая лишняя тема мгновенно возвращает последовательность к шагу 1.
4. **Действия**
   - Success: success_topic = puzzle/result, success_payload = unlocked, success_audio_track = /sdcard/audio/success.mp3, success_scenario = unlock_sequence.
   - Fail: ail_topic = puzzle/result, ail_payload = error, ail_audio_track = /sdcard/audio/fail.mp3, ail_scenario = reset_sequence.
5. **Сценарии**
   - unlock_sequence: шаг 1 — MQTT elay/cmd с open; шаг 2 — воспроизвести /sdcard/audio/unlocked.mp3.
   - eset_sequence: шаг 1 — MQTT elay/cmd с lock; шаг 2 — set_flag sequence_ready=true.
6. **Проверка**
   - Отправьте 	ouch последовательно на plate/1…plate/6: в логе появятся строки [Sequence] step_ok …, запустится success-сценарий.
   - Отправьте сообщение не в том порядке: лог покажет event=fail, запустится fail-сценарий, следующая попытка снова начнётся с шага 1.

---

## РЎРѕРІРµС‚С‹ РїРѕ РЅР°СЃС‚СЂРѕР№РєРµ РІ РІРµР±-РёРЅС‚РµСЂС„РµР№СЃРµ

- РСЃРїРѕР»СЊР·СѓР№С‚Рµ **Wizard** РґР»СЏ Р±С‹СЃС‚СЂРѕРіРѕ СЃРѕР·РґР°РЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІР° вЂ” РєР°Р¶РґР°СЏ РєР°СЂС‚РѕС‡РєР° РјР°СЃС‚РµСЂР° СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓРµС‚ РѕРґРЅРѕРјСѓ С€Р°Р±Р»РѕРЅСѓ.
- JSON-РїСЂРѕСЃРјРѕС‚СЂ РІРЅРёР·Сѓ Simple Editor РїРѕРєР°Р·С‹РІР°РµС‚ РІСЃРµ РїРѕР»СЏ (`template.uid`, `template.signal` Рё С‚. Рґ.), СѓРґРѕР±РЅРѕ РґР»СЏ СЂСѓС‡РЅС‹С… РїСЂР°РІРѕРє.
- РџРѕСЃР»Рµ РёР·РјРµРЅРµРЅРёСЏ С€Р°Р±Р»РѕРЅРѕРІ РЅР°Р¶РјРёС‚Рµ **Reload**, С‡С‚РѕР±С‹ СЂР°РЅС‚Р°Р№Рј РїРµСЂРµС‡РёС‚Р°Р» РєРѕРЅС„РёРі.

---

## Р§РµРє-Р»РёСЃС‚ С‚РµСЃС‚РёСЂРѕРІР°РЅРёСЏ Р°РІС‚РѕРјР°С‚РёР·Р°С†РёРё

| РЁР°Рі | Р”РµР№СЃС‚РІРёРµ |
| --- | -------- |
| 1 | Р’РєР»СЋС‡РёС‚Рµ РїРѕРґСЂРѕР±РЅС‹Рµ Р»РѕРіРё: `esp_log_level_set("template_runtime", ESP_LOG_DEBUG)`. |
| 2 | РСЃРїРѕР»СЊР·СѓР№С‚Рµ MQTT-РєР»РёРµРЅС‚ (РЅР°РїСЂРёРјРµСЂ, `mosquitto_pub`) РґР»СЏ РёРјРёС‚Р°С†РёРё СѓСЃС‚СЂРѕР№СЃС‚РІ. |
| 3 | РџСЂРѕРІРµСЂСЏР№С‚Рµ С„Р»Р°РіРё Р°РІС‚РѕРјР°С‚РёР·Р°С†РёРё РІ Р»РѕРіР°С… (`automation: flag <РёРјСЏ> set to <Р·РЅР°С‡РµРЅРёРµ>`). |
| 4 | Р—Р°РїСѓСЃРєР°Р№С‚Рµ СЃС†РµРЅР°СЂРёРё РІСЂСѓС‡РЅСѓСЋ С‡РµСЂРµР· `/api/devices/run?device=<id>&scenario=<id>`. |

РљРѕРјР±РёРЅРёСЂСѓР№С‚Рµ С€Р°Р±Р»РѕРЅС‹: СѓСЃРїРµС€РЅС‹Р№ UID РјРѕР¶РµС‚ СЃС‚Р°РІРёС‚СЊ С„Р»Р°Рі РґР»СЏ `if_condition`, Р° `interval_task` Р±СѓРґРµС‚ РЅР°РїРѕРјРёРЅР°С‚СЊ СѓС‡Р°СЃС‚РЅРёРєР°Рј РєР°Р¶РґС‹Рµ РЅРµСЃРєРѕР»СЊРєРѕ СЃРµРєСѓРЅРґ.

