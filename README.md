# ESP32 Smart Broker System

Многофункциональная система на базе **ESP32-S3**, объединяющая управление устройствами, сценами, аудио, освещением и сенсорами через **MQTT**, **веб-интерфейс** и **автоматизацию**.

---

## 🧩 Архитектура проекта

Система состоит из нескольких уровней:

| Уровень | Компоненты | Описание |
|----------|-------------|----------|
| **Core (broker)** | `main`, `config_store`, `mqtt_core`, `event_bus`, `network`, `error_monitor`, `status_led` | Основной контроллер (ESP32-S3), координирующий все устройства и эффекты |
| **Automation layer** | `device_manager`, `automation_engine` | Управление устройствами, сценариями, условиями и флагами |
| **UI layer** | `web_ui`, `devices_wizard.js` | Веб-интерфейс для настройки, тестирования и визуализации |
| **Audio layer** | `audio_player` | Воспроизведение MP3/WAV/OGG (через I2S и Helix decoder) |
| **Network layer** | Wi-Fi, MQTT, NTP, mDNS | Подключение и синхронизация времени, брокер MQTT |
| **Hardware layer** | WS2815 LED, реле, сенсоры, DFPlayer, ультразвук | Работа с внешними устройствами через GPIO/I2C/UART |

---

## ⚙️ Основные возможности

- Управление несколькими устройствами и эффектами через MQTT.
- Автоматизация действий по сценариям (Automation Engine).
- Встроенный веб-интерфейс для редактирования конфигурации.
- Поддержка воспроизведения звука (через I2S и PCM5102A).
- Работа с адресными лентами WS2815, реле, датчиками.
- Защита от зависаний (WDT, Error Monitor).
- OTA-обновления (через web UI).
- Хранение конфигурации в NVS.

---

## 🧱 Структура проекта

```
📁 components/
├── audio_player/        → аудиоплеер с Helix MP3 decoder
├── automation_engine/   → обработка сценариев и автоматизации
├── config_store/        → работа с NVS и хранение настроек
├── device_manager/      → управление устройствами, флагами, JSON-конфигурацией
├── error_monitor/       → контроль ошибок и индикация состояния
├── event_bus/           → внутренняя шина событий
├── mqtt_core/           → MQTT-клиент, интеграция с event_bus
├── network/             → Wi-Fi, NTP, mDNS, SNTP
├── status_led/          → системный LED-индикатор
└── web_ui/              → встроенный HTTP-сервер и frontend

📁 main/
├── main.c               → точка входа приложения
├── CMakeLists.txt       → регистрация компонента
└── sdkconfig.defaults   → параметры сборки

📁 data/
└── devices_wizard.js    → JavaScript-интерфейс настройки устройств (Device Wizard)
```

---

## 🌐 Web UI

Веб-интерфейс запускается автоматически после старта системы.  
Он предоставляет:
- Панель статуса сети и устройств.
- Настройку устройств, вкладок, топиков и сценариев через **Device Wizard**.
- Просмотр логов и ручной запуск сценариев.
- OTA-обновление прошивки и аудиофайлов (опционально).

Главная страница:  
`http://<ip устройства>/`

---

## 📡 MQTT-интеграция

**MQTT-ядро (`mqtt_core`)** управляет обменом сообщений между устройствами и брокером.

- Поддерживается QoS 0/1, Retain, Keepalive.
- Темы формируются автоматически из конфигурации Device Manager.
- Входящие MQTT-сообщения транслируются во внутренний `event_bus`.

Пример топиков:
```
quest/altar1/activate
quest/radio/play
quest/door/open
```

---

## 🔄 Automation Engine

**Automation Engine** позволяет описывать сложные сценарии:

- последовательности действий (воспроизвести звук → ждать → включить свет);
- условия по флагам;
- циклы и задержки.

Типы шагов (actions):

| Тип | Описание |
|------|-----------|
| `mqtt_publish` | Отправить MQTT-сообщение |
| `audio_play` | Воспроизвести трек |
| `audio_stop` | Остановить звук |
| `set_flag` | Установить внутренний флаг |
| `wait_flags` | Подождать, пока флаги примут значения |
| `loop` | Повторить шаги ограниченное число раз |
| `event` | Отправить внутреннее событие |
| `delay` | Пауза перед следующим шагом |
| `nop` | Пустое действие (заглушка) |

---

## 🔊 Аудио-подсистема

**Компонент:** `audio_player`

- Работает через `I2S_STD_MODE`.
- Поддерживает **MP3**, **WAV**, **OGG** (Helix decoder).
- Воспроизводит файлы с SD-карты или из флеша.
- Управление через API:
  ```c
  audio_player_play("/sdcard/intro.mp3");
  audio_player_stop();
  audio_player_set_volume(70);
  ```

---

## 💡 Индикация и диагностика

**Status LED** отображает состояние системы:
- 🔴 мигает — ошибка Wi-Fi или SD;
- 🟢 горит — всё в порядке;
- 🔴 постоянно — критическая ошибка.

**Error Monitor** собирает флаги (`wifi_ok`, `sd_fault`) и управляет светом.

---

## 🌐 Сетевые функции

- STA + AP-режим: при отсутствии Wi-Fi создаётся точка `ESP32-Broker`.
- Автоподключение к последней сети.
- Автоматическая синхронизация времени (SNTP).
- Объявление имени устройства через mDNS.

---

## 🛠️ Сборка и прошивка

Требуется:
- ESP-IDF v5.3+
- ESP32-S3 с PSRAM (рекомендуется 8–16 MB)

### Установка зависимостей
```bash
idf.py add-dependency "espressif/esp_websocket_client"
idf.py add-dependency "espressif/esp_http_server"
```

### Сборка и прошивка
```bash
idf.py build
idf.py flash monitor
```

---

## 🧮 Пример API (HTTP)

| Метод | URL | Описание |
|--------|------|----------|
| `GET` | `/api/devices/config` | Получить текущую конфигурацию |
| `POST` | `/api/devices/apply` | Применить новую конфигурацию |
| `GET` | `/api/devices/run?device=X&scenario=Y` | Запустить сценарий вручную |

---

## 🗁 Конфигурация по умолчанию

Хранится в `config_store` → NVS namespace `cfg`.

```c
typedef struct {
  char ssid[32];
  char password[64];
  char hostname[32];
  char broker_host[64];
  uint16_t broker_port;
  char ntp_server[64];
  int timezone_offset_min;
} app_config_t;
```

---

## 🧠 Безопасность и надёжность

- WDT активирован на всех задачах.
- Семафоры и критические секции защищают общие ресурсы.
- Ошибки сети или MQTT не блокируют основной поток.
- Возможна работа в автономном режиме (без брокера).

---

## 🚀 Как расширить проект

Добавить новое устройство:
1. Создать компонент или MQTT-устройство.
2. Зарегистрировать его в `device_manager`.
3. Добавить новый тип действий в `automation_engine`.
4. Описать вкладку в `web_ui` или `devices_wizard.js`.

---

## 📜 Лицензия

MIT License  
Автор проекта: **Александр [2024–2025]**

---

## 💬 Контакты

- Email: <racalcity@gmail.com>
- Telegram: @spokooha
- GitHub: [https://github.com/racalcity-maker/brocker_esp32s3]

