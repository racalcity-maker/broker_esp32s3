# Broker ESP32-S3

Мини‑контроллер на ESP32-S3, который воспроизводит аудио с SD‑карты, управляется через web-интерфейс и MQTT, а также поддерживает внешние режимы “sarcastic”/“broken”. Репозиторий оформлен под ESP-IDF 5.x и рассчитан на плату с 8 МБ PSRAM и поддержкой I2S-аудио.

## Структура проекта

- `main/` – точка входа приложения и регистрация компонент.
- `components/`
  - `audio_player/` – I2S + SD, WAV, MP3 (Helix), управление буферами в PSRAM.
  - `config_store/` – Wi-Fi, NTP, MQTT, пути робота в NVS.
  - `network/` – STA/AP, mDNS, SNTP.
  - `event_bus/` – внутренняя шина событий.
  - `mqtt_core/` – клиент MQTT с ACL и публикацией системных событий.
  - `web_ui/` – HTTP/UI + WebSocket, написанный как статическая страница в `web_ui.c`.
- `managed_components/` – зависимости ESP-IDF/component manager.
- `sdkconfig` – текущая конфигурация.

## Требования

- ESP-IDF 5.x (или актуальная версия для ESP32-S3);
- Python 3.8+ (идет вместе с ESP-IDF);
- Плата ESP32-S3 с 8 МБ PSRAM;
- SD-карта с аудиофайлами (FAT32), внешний I2S ЦАП/усилитель;
- MQTT-брокер (например, Mosquitto).

## Быстрый старт

```bash
idf.py set-target esp32s3
idf.py menuconfig      # по необходимости
idf.py build flash monitor
```

Команда `idf.py monitor` запускает просмотр логов, выход — `Ctrl+]`, затем Enter. Перед прошивкой удостоверьтесь, что выбран корректный COM-порт и драйвер установлен.

## Первичная настройка

1. После загрузки устройство поднимает точку доступа Broker-Setup (пароль 12345678) и параллельно пытается подключиться к STA.
2. Подключитесь к AP, откройте `http://192.168.4.1`.
3. На вкладке **Settings** задайте SSID, пароль, MQTT-хост/порт/логин.
4. Сохраните настройки; после успешного подключения AP отключится, а IP станции появится в верхнем баннере.

## Web UI (вкладка Audio)

- Управление громкостью, пауза, стоп, повтор, прогресс-бар с ручным `seek`.
- Обозреватель SD-карты: карточки треков, выбор каталога, подсветка активного трека.
- Статус плеера обновляется через poll `/api/status`.

### Вкладки Pictures / Laser / Robot

- **Pictures** – выбор треков для положительных/отрицательных событий и редактирование UID устройств.
- **Laser** – настройки лазера/реле и трека удержания.
- **Robot** – управление preset’ами и двумя режимами:
  - Sarcastic (`robot/mode/sarcastic`);
  - Broken (`robot/broken/on`).

При включении одного режима второй автоматически выключается. Кнопки подсвечивают активное состояние, последний выбранный режим выделяется дополнительным свечением. Перед использованием заполните поля `robot/mode/sarcastic dir` и `robot/broken dir` и нажмите **Save**.

## API/Endpoints

- `/api/status` – текущее состояние (Wi-Fi, SD, audio, robot, laser).
- `/api/files?path=/sdcard/...` – список файлов/папок.
- `/api/audio/play|pause|resume|stop|seek|volume` – управление плеером.
- `/api/robot/*` – конфигурация робота и пресеты.
- `/api/pictures/*`, `/api/laser/*` – соответствующие модули.

## Частые проблемы

| Симптом | Действие |
| --- | --- |
| `idf.py flash` не видит порт | Проверьте кабель/драйвер, закройте другие терминалы, укажите порт флагом `-p COMx`. |
| `httpd_sock_err: error in recv : 104` | Слишком много запросов/разрыв соединения — перезапустите плату, избегайте множественных кликов подряд. |
| Нет файлов в Audio | Убедитесь, что SD-карта FAT32, вставлена до запуска и содержит аудио (WAV/MP3). Нажмите **Refresh files**. |
| Режимы робота не переключаются | Проверьте поля каталогов в **Settings** и статус MQTT. Кнопки ждут завершения предыдущего режима ~0.8 с. |

## Полезные команды

- `idf.py -p COMx erase_flash` – очистка флеша.
- `idf.py monitor --baud 115200` – монитор с нужной скоростью.
- `curl http://<ip>/api/status` – проверка состояния без UI.

## Поддержка

Документ “instruction_beginners.docx” хранится в корне и описывает пошаговый запуск. Для доработок UI или плеера см. соответствующие компоненты в `components/`. Вопросы и баги фиксируйте в issue-трекере или напрямую в чат разработчиков.
