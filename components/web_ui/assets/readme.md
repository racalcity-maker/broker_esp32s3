# Device Wizard для брокера ESP32

Этот интерфейс — визуальный «мастер настроек» устройств и сценариев,
которые выполняет твой ESP32-брокер.  
Он позволяет **без правки кода**:

- добавлять / удалять устройства;
- настраивать вкладки (Tabs) для веб-интерфейса;
- описывать MQTT-топики;
- собирать сценарии из шагов (action steps);
- запускать сценарии вручную для теста.

Файл интерфейса: `devices_wizard.js`  
Контейнер в HTML: элемент с id `device_wizard_root`.

---

## 1. Где это открыть

1. Подними брокер на ESP32 (прошивка уже должна быть загружена).
2. Открой веб-интерфейс брокера в браузере:
   - обычно это `http://<ip_устройства>/`.
3. Перейди на страницу с конфигуратором устройств (Device Wizard).
   - там должен быть блок с надписью **"Devices"** или похожей,
   - внутри есть контейнер `<div id="device_wizard_root"></div>`.

После загрузки страницы скрипт сам подцепится и отрисует интерфейс.

---

## 2. Основные элементы интерфейса

### Верхняя панель (Globals + Toolbar)

- **Tab limit** — максимальное количество вкладок (Tabs) для устройств.
- **Schema version** — версия схемы конфигурации (для разработчика, только чтение).

Кнопки:

- **Reload** — перечитать конфигурацию с устройства (`GET /api/devices/config`).
- **Add device** — добавить новое устройство.
- **Clone** — клонировать выбранное устройство.
- **Delete** — удалить выбранное устройство.
- **Save changes** — сохранить изменения на устройство (`POST /api/devices/apply`).

Справа отображается статус:
- `Not loaded`, `Loading…`, `Loaded`, `Saved`, `Load failed`, `Save failed: …`

---

## 3. Как пользоваться (для обычного пользователя)

### Шаг 1. Выбор или создание устройства

Слева — список устройств:

- Каждая строка — одно устройство.
- Справа значок-бейдж — сколько сценариев у устройства.

Действия:

- Клик по устройству — выбрать его для редактирования.
- Кнопка **Add device** — создать новое.
- Кнопка **Clone** — копия выбранного (удобно, чтобы не собирать всё с нуля).
- Кнопка **Delete** — удалить выбранное устройство.

В правой части в секции **Basics**:

- **Device ID** — внутренний идентификатор (латиница, без пробелов).
- **Display name** — понятное имя, которое видно в веб-интерфейсе.

---

### Шаг 2. Вкладки (Tabs)

Секция **Tabs**:

Здесь задаются вкладки, которые будут видны в интерфейсе устройства (иконки/страницы).

Для каждой строки:

- **Type** — тип вкладки:
  - `audio`, `pictures`, `laser`, `robot`, `custom`
- **Label** — подпись на вкладке (что видит пользователь).
- **Extra** — дополнительное поле (строка), если нужно прокинуть какие-то данные.

Кнопка **Add tab** — добавить новую вкладку.  
Крестик `×` справа — удалить вкладку.

---

### Шаг 3. Топики (Topics)

Секция **Topics**:

Тут настраиваются понятные имена и реальные MQTT-топики, с которыми работает устройство.

Для каждой строки:

- **Name** — логическое имя (например, `light_on`, `door_unlock`).
- **Topic** — реальный MQTT-топик (например, `house/room1/light/cmd`).

Кнопка **Add topic** — добавить новую строку.  
Крестик `×` справа — удалить.

---

### Шаг 4. Сценарии (Scenarios)

Секция **Scenarios** делится на две части:

1. **Список сценариев** слева:
   - Список карточек, каждая — это сценарий.
   - Бейдж справа — число шагов в сценарии.

   Кнопки:
   - **Add** — добавить новый сценарий.
   - **Delete** — удалить текущий выбранный сценарий.

2. **Детали сценария** справа:
   - **Scenario ID** — внутренний идентификатор (латиница, без пробелов).
   - **Scenario name** — удобное имя для человека.

#### Шаги сценария (Steps)

Ниже идут карточки шагов:

- **Type** — тип действия.
- **Delay ms** — задержка перед выполнением этого шага (в миллисекундах).

Поддерживаемые типы действий:

- `mqtt_publish` — отправка MQTT-сообщения.
- `audio_play` — воспроизведение аудио-трека.
- `audio_stop` — (резерв, зависит от реализации на прошивке).
- `laser_trigger` — сработать лазером/эффектом (зависит от устройства).
- `set_flag` — установить внутренний флаг (логическая переменная).
- `wait_flags` — подождать, пока флаги не примут нужные значения.
- `loop` — зациклиться на другом шаге сценария ограниченное число раз.
- `delay` — задержка (если нужно как отдельное действие).
- `event` — отправить событие (внутреннее).
- `nop` — «ничего не делать» (заглушка).

У каждой карточки есть кнопки:

- `↑` / `↓` — переставить шаг вверх/вниз.
- `Delete` — удалить шаг.
- **Add step** — добавить новый шаг в конец.

Поля внутри карточки зависят от типа:

- Для **mqtt_publish**:
  - Topic, Payload, QoS, Retain.
- Для **audio_play**:
  - Track path (путь к файлу), Blocking (ждать завершения или нет).
- Для **set_flag**:
  - Flag name, Value (True/False).
- Для **wait_flags**:
  - Mode (`all` / `any`),
  - Timeout ms,
  - Список требований (флаг + требуемое состояние).
- Для **loop**:
  - Target step (номер шага, на который прыгать),
  - Max iterations (максимум итераций цикла).
- Для **event**:
  - Event, Topic, Payload.

---

### Шаг 5. Сохранение

Когда ты что-то меняешь, снизу обновляется JSON-превью, а кнопка **Save changes** становится активной.

- Нажми **Save changes** — конфигурация отправляется на устройство (`POST /api/devices/apply`).
- При успехе:
  - статус: `Saved`
  - интерфейс обновит список устройств для ручного запуска сценариев.

---

## 4. Ручной запуск сценария (Run panel)

Внизу страницы предусмотрена панель тестов (если она есть в верстке):

- Выпадающий список устройств (**Device**).
- Выпадающий список сценариев (**Scenario**).
- Кнопка **Run / Trigger**.
- Текстовый статус.

При нажатии:

1. Собирается URL:
2. Отправляется запрос `GET`.
3. В статус выводится:
- `Triggering...`,
- затем `Scenario queued` или сообщение об ошибке.

Это удобно, чтобы проверить сценарий, не проходя реальную игру/квест.

---

## 5. Структура данных (для разработчиков)

> Обычным пользователям можно этот раздел не показывать.

Пример структуры, которую редактирует Device Wizard:

```json
{
"schema": 1,
"tab_limit": 12,
"devices": [
 {
   "id": "radio",
   "display_name": "Радиола",
   "tabs": [
     {"type": "audio", "label": "Музыка", "extra_payload": ""}
   ],
   "topics": [
     {"name": "play", "topic": "quest/radio/play"},
     {"name": "stop", "topic": "quest/radio/stop"}
   ],
   "scenarios": [
     {
       "id": "intro",
       "name": "Стартовый трек",
       "steps": [
         {
           "type": "audio_play",
           "delay_ms": 0,
           "data": {
             "audio": {
               "track": "/sdcard/tracks/intro.mp3",
               "blocking": true
             }
           }
         }
       ]
     }
   ]
 }
]
}
